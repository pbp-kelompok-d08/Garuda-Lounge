{% extends 'base_news.html' %}
{% load static %}

{% block title %}Garuda Lounge News{% endblock %}

{% block content %}
<style>
  :root{
    --bg:#E7E3DD; --red:#AA1515; --black:#111; --white:#fff;
    --red-soft: rgba(170,21,21,.22);
    --red-soft-2: rgba(170,21,21,.32);
  }

  .wrap{ max-width:1000px; margin:0 auto; padding:40px 16px; text-align:center; }
  .title{ font-family:'Montserrat',sans-serif; font-weight:800; color:var(--red); margin:0 0 10px; }

  /* Tombol kecil  "View Details" */
  .btn-mini {
    font-size: 0.75rem !important;
    font-weight: 600;
    color: var(--red) !important;
    background: transparent !important;
    border: none !important;
    text-decoration: none !important;
    display: inline-block;
    line-height: 1.2;
    transition: color .2s ease, transform .2s ease, text-decoration .2s ease;
  }
  .btn-mini:hover {
    color: #7f0f12 !important;
    text-decoration: underline !important;
    transform: translateY(-1px);
  }

  /* Buttons (untuk Tambah Berita) */
  .btn{
    display:inline-block;
    padding:8px 14px;
    border-radius:8px;
    border:1.5px solid var(--red);
    background:var(--red);
    color:var(--white);
    font-weight:700;
    cursor:pointer;
    transition:filter .2s, transform .2s;
    text-decoration:none !important;  
  }
  .btn:hover{
    filter:brightness(1.05);
    transform:translateY(-1px);
    text-decoration:none !important;   
  }

  .btn-outline{
    background:transparent; color:var(--red); border:1.5px solid var(--red);
  }

  /* Tabs */
  .tabs{ display:inline-flex; gap:10px; margin:18px 0 28px; }
  .tab{
    padding:8px 12px; border:1.5px solid var(--red); border-radius:999px;
    background:var(--white); color:var(--red); font-weight:700; cursor:pointer;
    transition:background .2s,color .2s;
  }
  .tab.active{ background:var(--red); color:#fff; }

  /* Grid & Card */
  .grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(280px,1fr)); gap:18px; align-items:stretch; }
  .card{
    background:#fff;
    border:1.5px solid var(--red);
    border-radius:16px;
    box-shadow:0 4px 10px var(--red-soft);
    text-align:left; overflow:hidden; display:flex; flex-direction:column;
    transition:transform .25s, box-shadow .25s;
  }
  .card:hover{
    transform:translateY(-3px);
    box-shadow:0 8px 18px var(--red-soft-2);
  }

  .thumb{ width:100%; height:180px; object-fit:cover; border-bottom:1px solid #F3DADA; }
  .card-body{ padding:12px; display:flex; flex-direction:column; gap:8px; }
  .h3{ font-family:'Montserrat',sans-serif; font-weight:800; font-size:1.1rem; margin:0; color:var(--red); }
  .meta{ font-size:.9rem; color:#6b6b6b; }
  .excerpt{
    color:#333; font-size:.95rem; line-height:1.5;
    display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden;
  }
  .empty{ color:#111; margin-top:26px; }
</style>

<div class="wrap">
  <h1 class="title">Garuda Lounge News</h1>

  <div class="tabs">
    <button id="filter-all" class="tab active">All News</button>
    <button id="filter-my"  class="tab">My News</button>
  </div>

  <!-- Tombol tambah berita -->
  <div>
    <a href="{% url 'news:create_news' %}" class="btn">+ Tambah Berita</a>
  </div>

  <div id="loading" class="empty" style="display:none;">Loading…</div>

  <div id="empty" class="empty" style="display:none;">
    <img src="{% static 'image/no-news.png' %}" alt="No news"
         style="width:110px;height:110px;opacity:.7;display:block;margin:0 auto 8px;">
    Belum ada berita saat ini.
  </div>

  <div id="grid" class="grid" style="display:none;"></div>
</div>

<script>
  const NEWS_API_ENDPOINT = "{% url 'news:show_json' %}";
  const CURRENT_USER_ID = "{{ request.user.id|default_if_none:'' }}";

  const loadingEl = document.getElementById('loading');
  const emptyEl   = document.getElementById('empty');
  const gridEl    = document.getElementById('grid');
  const tabAll    = document.getElementById('filter-all');
  const tabMy     = document.getElementById('filter-my');

  let allNewsData = [];
  let activeFilter = 'all';

  function setView({loading=false, empty=false, grid=false}) {
    loadingEl.style.display = loading ? 'block' : 'none';
    emptyEl.style.display   = empty   ? 'block' : 'none';
    gridEl.style.display    = grid    ? 'grid'  : 'none';
  }

  function buildNewsCard(n) {
    const linkDetail = `/news/${n.id}/`;
    const linkEdit   = `/news/${n.id}/edit/`;
    const linkDelete = `/news/${n.id}/delete/`;
    const canEdit    = !!(CURRENT_USER_ID && String(n.user_id) === String(CURRENT_USER_ID));

    const card = document.createElement('article');
    card.className = 'card';
    card.innerHTML = `
      ${n.thumbnail ? `<img src="${n.thumbnail}" class="thumb" alt="">` : ``}
      <div class="card-body">
        <h3 class="h3"><a href="${linkDetail}" style="color:inherit;text-decoration:none">${n.title}</a></h3>
        <div class="meta">${n.category_label || n.category} • ${new Date(n.created_at).toLocaleDateString()}</div>
        <p class="excerpt">${n.content || ''}</p>
        <div style="margin-top:auto; display:flex; gap:12px; align-items:center;">
          <a href="${linkDetail}" class="btn-mini">Baca →</a>
          ${canEdit ? `
            <a href="${linkEdit}" class="btn-mini">Edit</a>
            <a href="${linkDelete}" class="btn-mini" style="color:#b3261e;" onclick="return confirm('Hapus berita ini?')">Delete</a>
          ` : ``}
        </div>
      </div>
    `;
    return card;
  }

  function renderNews(list) {
    gridEl.innerHTML = '';
    list.forEach(n => gridEl.appendChild(buildNewsCard(n)));
    setView({ grid: list.length > 0, empty: list.length === 0 });
  }

  function applyFilter() {
    const filtered = (activeFilter === 'all')
      ? allNewsData
      : allNewsData.filter(n => String(n.user_id) === String(CURRENT_USER_ID));
    renderNews(filtered);
  }

  async function fetchNews() {
    setView({ loading: true });
    try {
      const res = await fetch(NEWS_API_ENDPOINT);
      if (!res.ok) throw new Error('fetch failed');
      const data = await res.json();
      allNewsData = Array.isArray(data) ? data : [];
      applyFilter();
    } catch (e) {
      console.error(e);
      setView({ empty: true });
    }
  }

  tabAll.addEventListener('click', () => {
    activeFilter = 'all';
    tabAll.classList.add('active'); tabMy.classList.remove('active');
    applyFilter();
  });
  tabMy.addEventListener('click', () => {
    activeFilter = 'my';
    tabMy.classList.add('active'); tabAll.classList.remove('active');
    applyFilter();
  });

  fetchNews();
  document.addEventListener('newsAdded', () => fetchNews());
</script>
{% endblock %}

{% include 'toast.html' %}
{% include 'modal.html' %}
