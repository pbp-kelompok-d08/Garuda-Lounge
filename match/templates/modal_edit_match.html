{% load static %}

<div id="editMatchModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm">
  <div id="editMatchModalContent" 
       class="bg-white rounded-2xl shadow-[6px_6px_0_#111] border-2 border-[#111111] w-11/12 sm:w-3/5 lg:w-4/5 max-h-[90vh] overflow-y-auto transform scale-95 opacity-0 transition-all duration-200">

    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-[#E7E3DD] rounded-t-2xl">
      <div>
        <h3 class="text-xl font-extrabold font-[Montserrat] text-[#111111]">
          Edit Match
        </h3>
        <p class="text-sm text-[#555] mt-1 font-[Inter]">
          Perbarui detail pertandingan
        </p>
      </div>
      <button type="button" class="text-[#111111] hover:bg-[#ffffffcc] rounded-md p-2 transition" onclick="hideEditModal()" aria-label="Close">
        âœ•
      </button>
    </div>

    <form id="editMatchForm" class="space-y-4">
        <input type="hidden" id="edit_match_id" name="edit_match_id">
            
        <div id="edit-form-content" class="px-6 py-5 space-y-5 font-[Inter] text-[#111111]">
            
            <div id="edit-form-loading" class="text-center p-8">
                <svg class="animate-spin h-6 w-6 text-red-600 inline-block" ...>
                   </svg>
                <p class="text-gray-500 mt-2">Loading data...</p>
            </div>
        </div>
    </form>

    <div class="flex flex-col sm:flex-row gap-3 px-6 py-5 border-t border-gray-200 bg-[#E7E3DD] rounded-b-2xl">
      <button type="button" class="order-2 sm:order-1 ... " onclick="hideEditModal()">
        Cancel
      </button>
      <button type="submit" form="editMatchForm" class="order-1 sm:order-2 ...">
        Simpan Perubahan
      </button>
    </div>
  </div>
</div>

<script>
  // Fungsi untuk menampilkan modal Edit
  async function showEditModal(matchId) {
    const modal = document.getElementById('editMatchModal');
    const modalContent = document.getElementById('editMatchModalContent');
    const formContent = document.getElementById('edit-form-content');
    const loadingSpinner = document.getElementById('edit-form-loading');
    
    // Tampilkan modal dan spinner
    modal.classList.remove('hidden');
    loadingSpinner.style.display = 'block';
    formContent.innerHTML = ''; // Kosongkan form lama
    setTimeout(() => {
      modalContent.classList.remove('opacity-0', 'scale-95');
      modalContent.classList.add('opacity-100', 'scale-100');
    }, 30);

    // Simpan ID di hidden input
    document.getElementById('edit_match_id').value = matchId;

    // 1. Ambil HTML form yang sudah di-render untuk match ini
    // (Anda harus membuat URL 'match:get_edit_form_html' ini)
    const response = await fetch(`/match/${matchId}/get-form-html/`);
    const data = await response.json();
    
    // 2. Suntikkan HTML form ke dalam modal
    loadingSpinner.style.display = 'none';
    formContent.innerHTML = data.html;
  }

  // Fungsi untuk menyembunyikan modal Edit
  function hideEditModal() {
    const modal = document.getElementById('editMatchModal');
    const modalContent = document.getElementById('editMatchModalContent');
    modalContent.classList.remove('opacity-100', 'scale-100');
    modalContent.classList.add('opacity-0', 'scale-95');
    setTimeout(() => modal.classList.add('hidden'), 180);
  }

  // Fungsi untuk mengirim data edit
  async function editMatchEntry() {
    const matchId = document.getElementById('edit_match_id').value;
    const form = document.querySelector('#editMatchForm');
    
    // (Anda harus membuat URL 'match:edit_match_ajax' ini)
    const res = await fetch(`/match/${matchId}/edit-ajax/`, {
      method: "POST",
      body: new FormData(form),
    });

    hideEditModal();

    if (typeof showToast === 'function') {
      showToast('Success', 'Match berhasil diperbarui!', 'success');
    }
    
    // Trigger refresh di match.html
    document.dispatchEvent(new CustomEvent('matchAdded')); // Kita pakai event yang sama
  }

  // Event listener untuk tombol "Simpan Perubahan"
  document.getElementById("editMatchForm").addEventListener("submit", function(e) {
    e.preventDefault();
    editMatchEntry();
  });
</script>