{% extends 'base_match.html' %}
{% load static %}

{% block meta %}
<title>GarudaLounge - Match</title>
{% endblock meta %}


{% block content %}
<div class="content px-4 py-8 max-w-7xl mx-auto"> 
    <div class="mb-4"> <a href="{% url 'main:show_main' %}">
            <button style="
                background-color: #a4161a;
                color: white;
                border: none;
                padding: 8px 14px;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
                transition: 0.3s;
            "
            onmouseover="this.style.backgroundColor='#6e0f11'"
            onmouseout="this.style.backgroundColor='#a4161a'">
                ‚Üê Back to Main Page
            </button>
        </a>
    </div>

    <h1 style="text-align: center; color: #a4161a; margin-top: 0; margin-bottom: 20px; font-size: 2.25rem;" class="font-heading">
        <span>Garuda </span> <span>Lounge </span> <span>Match</span>
    </h1>

    <div class="mb-6 flex flex-wrap justify-center items-center gap-4"> 
        
      <!-- {% if user.is_superuser %} -->
        <div> 
            <button type="button" onclick="showMatchModal()" style="
                    background-color: #a4161a;
                    color: white;
                    border: none;
                    padding: 10px 16px; /* Padding besar */
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: 0.3s;
                "
                onmouseover="this.style.backgroundColor='#6e0f11'"
                onmouseout="this.style.backgroundColor='#a4161a'">
                + Tambah Match
            </button>
        </div>
      <!-- {% endif %} -->


      <!-- <div class="flex flex-wrap justify-center gap-3"> -->
            <button type="button" class="filter-button active" data-filter="all" onclick="filterMatches('all')">
                Semua Match
            </button>
            <button type="button" class="filter-button" data-filter="kualifikasi piala dunia" onclick="filterMatches('kualifikasi piala dunia')">
                Kualifikasi Piala Dunia
            </button>
            <button type="button" class="filter-button" data-filter="piala asia" onclick="filterMatches('piala asia')">
                Piala Asia
            </button>
            <button type="button" class="filter-button" data-filter="piala asean" onclick="filterMatches('piala asean')"> Piala ASEAN 
            </button>
            <button type="button" class="filter-button" data-filter="pertandingan persahabatan" onclick="filterMatches('pertandingan persahabatan')">
                Pertandingan Persahabatan
            </button>
        <!-- </div> -->
        
    </div>

    <div id="loading" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
      <svg class="animate-spin h-8 w-8 text-red-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <p class="text-gray-600 mt-3">Loading matches...</p>
    </div>

    <div id="error" class="hidden">
        <p class="text-center text-red-600">Gagal memuat pertandingan.</p>
    </div>

    <div id="grid" class="hidden">
        </div>

    <div id="empty" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
      <h3 class="text-lg font-medium text-gray-900 mb-2">Belum ada pertandingan</h3>
    </div>
</div>


<script>
// Configuration
const MATCH_API_ENDPOINT = "{% url 'match:show_match_json' %}";
// const IS_SUPERUSER_STRING = "{{ user.is_superuser|yesno:'true,false' }}";  // Untuk tombol Edit/Delete

// DOM Elements
const loadingSpinner = document.getElementById('loading');
const errorMessage = document.getElementById('error');
const emptyStateDisplay = document.getElementById('empty');
const matchGridContainer = document.getElementById('grid');
const filterButtons = document.querySelectorAll('.filter-button'); // Ambil semua tombol filter

// State Variable
let allMatchData = [];
let currentFilter = 'all';

function toTitleCase(str) {
  if (!str) return ''; // Mengatasi string kosong
  return str.toLowerCase().split(' ').map(function(word) {
    // huruf pertama kapital, lalu gabung dengan sisanya
    return (word.charAt(0).toUpperCase() + word.slice(1));
  }).join(' ');
}

// Show/hide page sections
function displayPageSection({ showLoading = false, showError = false, showEmpty = false, showGrid = false }) {
  loadingSpinner.classList.toggle('hidden', !showLoading);
  errorMessage.classList.toggle('hidden', !showError);
  emptyStateDisplay.classList.toggle('hidden', !showEmpty);
  matchGridContainer.classList.toggle('hidden', !showGrid);
  
  if (showGrid) {
    matchGridContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
  }
}

function updateButtonStyles() {
    filterButtons.forEach(button => {
        const filterValue = button.getAttribute('data-filter');
        // Tentukan button filter yang dipilih agar di-styling
        if (filterValue.toLowerCase() === currentFilter.toLowerCase()) {
            button.classList.add('active'); 
        } else {
            button.classList.remove('active');
        }
    });
}


function buildMatchCardElement(item) {
    const article = document.createElement('article');
    article.className = 'card-match'; 

    // Sanitasi data untuk keamanan (dari main.html)
    const sanitizedJenis = DOMPurify.sanitize(item.jenis_pertandingan);
    const jenis = toTitleCase(sanitizedJenis);
    const tanggal = DOMPurify.sanitize(item.tanggal);
    const benderaTuanRumah = DOMPurify.sanitize(item.bendera_tuan_rumah);
    const timTuanRumah = DOMPurify.sanitize(item.tim_tuan_rumah);
    const skorTuanRumah = DOMPurify.sanitize(item.skor_tuan_rumah);
    const benderaTamu = DOMPurify.sanitize(item.bendera_tamu);
    const timTamu = DOMPurify.sanitize(item.tim_tamu);
    const skorTamu = DOMPurify.sanitize(item.skor_tamu);
    const highlightLink = DOMPurify.sanitize(item.highlight);

   // URL untuk tombol match details dan delete
    const linkDetail = `{% url 'match:show_match_details' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.id);
    const linkDelete = `{% url 'match:delete_match' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.id);

    // Tombol edit dan delete (hanya untuk superuser)
    let editDeleteHtml = ''; 
    // if (IS_SUPERUSER_STRING === "true") {
    editDeleteHtml = `<div class='flex space-x-2'>
        <button type="button" onclick="showEditModal('${item.id}')" class='card-action-link'>Edit</button>
        <a href='${linkDelete}' class='card-action-link card-action-delete'>Delete</a>
      </div>`;
    // }

    const cardHtml = `
        <div class="card-header">
            <span class="jenis-pertandingan">
                ${jenis}
            </span>
            <span class="tanggal">
                ${tanggal}
            </span>
        </div>

        <div class="card-body">
            <div class="match-details">
                <div class="team-row">
                    <div class="team-info">
                        <img src="${benderaTuanRumah}" alt="Bendera ${timTuanRumah}">
                        <span>${timTuanRumah}</span>
                    </div>
                    <span class="skor">${skorTuanRumah}</span>
                </div>
                <div class="team-row">
                    <div class="team-info">
                        <img src="${benderaTamu}" alt="Bendera ${timTamu}">
                        <span>${timTamu}</span>
                    </div>
                    <span class="skor">${skorTamu}</span>
                </div>
            </div>
            <div class="highlight-link">
                <a href="${highlightLink}" target="_blank">Lihat Highlight</a>
            </div>
        </div>

        <div class="px-3 pt-3 pb-0">
            <div class="flex items-center justify-between">
                <a href="${linkDetail}" class="card-action-link card-action-detail">
                    Match Details
                </a>
                ${editDeleteHtml}
            </div>
        </div>
    `;
    
    article.innerHTML = cardHtml;
    return article;
}

// Render semua kartu pertandingan
function renderAllMatchCards(matchItems) {
  matchGridContainer.innerHTML = ''; // Kosongkan grid

  // Filter data berdasarkan currentFilter 
  const filteredMatches = allMatchData.filter(item => {
      if (currentFilter === 'all') {
          return true; // Tampilkan semua card pertandingan
      }
      // Ubah jadi case insensitive
      const jenisPertandinganLower = (item.jenis_pertandingan ?? '').toLowerCase();
      return jenisPertandinganLower === currentFilter.toLowerCase();
  });

  // Render hasil filter
  if (filteredMatches.length === 0) {
    emptyStateDisplay.querySelector('h3').textContent = `Tidak ada pertandingan "${toTitleCase(currentFilter)}"`;
    emptyStateDisplay.querySelector('p').textContent = 'Coba pilih filter lain atau tambahkan pertandingan baru.';
    displayPageSection({ showEmpty: true });
  } else {
    filteredMatches.forEach(item => {
      const cardElement = buildMatchCardElement(item);
      matchGridContainer.appendChild(cardElement);
    });
    displayPageSection({ showGrid: true });
  }
}

function filterMatches(category) {
    currentFilter = category.toLowerCase(); // Update state filter 
    renderAllMatchCards();    // Render ulang kartu
    updateButtonStyles();     // Update style tombol
}

// Fetch data pertandingan dari server
async function fetchMatchesFromServer() {
  try {
    displayPageSection({ showLoading: true });
    
    const response = await fetch(MATCH_API_ENDPOINT, {
      headers: { 'Accept': 'application/json' },
    });
    
    if (!response.ok) {
      throw new Error('Gagal mengambil data pertandingan dari server');
    }

    const matchData = await response.json();
    allMatchData = matchData || [];
    renderAllMatchCards(); // Render pertama kali pakai filter 'all'
    updateButtonStyles(); // Set style tombol 'all' aktif
    
    renderAllMatchCards(allMatchData);
  } catch (error) {
    console.error('Error memuat pertandingan:', error);
    displayPageSection({ showError: true });
  }
}

// Bakal digunakan buat edit match juga
document.addEventListener('matchAdded', function() {
    // Refresh data without page reload
    fetchMatchesFromServer();
});

// Initialize page
function initializeMatchPage() {
  // Tidak ada filter, jadi langsung fetch data
  fetchMatchesFromServer();
}

// Start application
initializeMatchPage();

</script>
{% endblock content%}