{% extends 'base_merch.html' %}
{% load static %}

{% block title %}Merchandise Detail - GarudaLounge Merchandise{% endblock %}

{% block content %}
<!-- STATES -->
<div id="loading-state" class="bg-white rounded-xl2 border border-gray-200 p-10 text-center shadow-sub">
  <div class="animate-spin h-8 w-8 text-brandred inline-block border-4 border-t-transparent rounded-full"></div>
  <p class="text-gray-600 mt-3">Loading merch detail...</p>
</div>

<div id="error-state" class="bg-white rounded-xl2 border border-gray-200 p-10 text-center shadow-sub hidden">
  <div class="text-brandred text-5xl mb-2">⚠️</div>
  <h3 class="text-lg font-semibold text-ink mb-1">Failed to load merch</h3>
  <p class="text-gray-500">Please try again later.</p>
</div>

<!-- ARTICLE -->
<article id="article-content" class="bg-white rounded-xl2 border border-gray-200 overflow-hidden shadow-soft hidden">
  <div class="p-6 sm:p-8">
    <div id="badges-container" class="flex flex-wrap items-center gap-2 mb-4"></div>
    <h1 id="article-name" class="font-heading font-extrabold text-ink text-3xl sm:text-4xl leading-tight mb-3"></h1>
    <div class="flex flex-wrap items-center text-sm text-gray-500 gap-4">
      <span id="article-price"></span>
    </div>
  </div>

  <div id="featured-image-container" class="px-6 sm:px-8 hidden">
    <img id="featured-image" src="" alt="" class="w-full h-64 sm:h-80 lg:h-96 object-cover rounded-xl2 shadow-sub">
  </div>

  <div class="p-6 sm:p-8">
    <div id="article-description-text" class="text-gray-700 leading-relaxed whitespace-pre-line text-base sm:text-lg"></div>
  </div>

  <div>
    <a href="{{ merch.product_link }}"><button type="button" class="bg-brandred text-white px-4 py-2 rounded-xl2 font-bold active:translate-y-px">Buy Now</button></a>
  </div>

  <div class="border-t border-gray-200 p-6 sm:p-8 bg-gray-50">
    <p id="article-seller" class="font-semibold text-ink">Seller: Loading...</p>
    <p class="text-xs text-gray-500">Seller</p>
  </div>
</article>

<script>
  /* Endpoints */
  const MERCH_DETAIL_ENDPOINT = "{% url 'merchandise:show_json_by_id' merch.id %}";

  /* CSRF via cookie (benar untuk fetch) */
  function getCookie(name){
    const v = `; ${document.cookie}`.split(`; ${name}=`);
    if (v.length === 2) return v.pop().split(';').shift();
  }
  const CSRF = getCookie('csrftoken');

  /* DOM */
  const loadingState = document.getElementById('loading-state');
  const errorState   = document.getElementById('error-state');
  const articleEl    = document.getElementById('article-content');

  const badgesEl     = document.getElementById('badges-container');
  const nameEl      = document.getElementById('article-name');
  const priceEl      = document.getElementById('article-price');
  const figWrapEl    = document.getElementById('featured-image-container');
  const figEl        = document.getElementById('featured-image');
  const descriptionEl    = document.getElementById('article-description-text');
  const sellerEl     = document.getElementById('article-seller');

  function showState(s){
    loadingState.classList.toggle('hidden', s !== 'loading');
    errorState.classList.toggle('hidden',   s !== 'error');
    articleEl.classList.toggle('hidden',    s !== 'ready');
  }

  function catLabel(x){
    const m = { jersey:'Jersey', shoes:'Shoes', match:'Match', gk_gloves:'GK_Gloves', ball:'Ball', jacket:'Jacket', scarf:'Scarf' };
    return m[x] || x;
  }

  function badge(text, extraClass){
    const span = document.createElement('span');
    span.className = `inline-flex items-center px-3 py-1 rounded-full text-xs font-extrabold ${extraClass}`;
    span.textContent = text;
    return span;
  }

  function renderArticle(n){
    nameEl.textContent = n.name || '';
    document.name = `${n.name || 'Merchandise Detail'} - GarudaLounge Merchandise`;

    badgesEl.innerHTML = '';
    badgesEl.appendChild(badge(catLabel(n.category), 'bg-ink text-white'));

    if (n.thumbnail){
      figEl.src = n.thumbnail;
      figEl.alt = n.name || '';
      figWrapEl.classList.remove('hidden');
    } else {
      figWrapEl.classList.add('hidden');
    }

    descriptionEl.textContent = n.description || '';
    sellerEl.textContent  = `Author: ${n.user_username || 'Anonymous'}`;
  }

  async function loadMerch(){
    try{
      showState('loading');
      const r = await fetch(MERCH_DETAIL_ENDPOINT, { headers: { 'Accept': 'application/json' }});
      if (!r.ok) throw new Error('Failed to fetch');
      const n = await r.json();
      renderArticle(n);
      showState('ready');
    }catch(e){
      console.error(e);
      showState('error');
    }
  }

  // init
  loadMerch();
</script>
{% endblock %}