{% extends 'base_merch.html' %}
{% load static %}

{% block title %}Garuda Lounge Merchandise{% endblock %}

{% block content %}
<style>
  :root{
    --bg:#E7E3DD; --red:#AA1515; --black:#111; --white:#fff;
    --red-soft: rgba(170,21,21,.22);
    --red-soft-2: rgba(170,21,21,.32);
  }
  .wrap{ max-width:1000px; margin:0 auto; padding:60px 16px 36px; }
  .header-stack{ text-align:center; margin-bottom:0; }
  .title{ font-family:'Montserrat',sans-serif; font-weight:800; color:var(--red); margin:0; }
  .controls-row{ display:inline-flex; align-items:center; gap:12px; margin-top:8px; margin-bottom:28px; }
  .btn{ display:inline-block; padding:8px 14px; border-radius:8px; border:1.5px solid var(--red); background:var(--red); color:var(--white); font-weight:700; cursor:pointer; transition:filter .2s, transform .2s; text-decoration:none!important; }
  .btn:hover{ filter:brightness(1.05); transform:translateY(-1px); }
  .btn-outline{ background:transparent; color:var(--red); border:1.5px solid var(--red); }
  .btn-mini{ font-size:.8rem; font-weight:600; color:var(--red); background:transparent; border:none; padding:0; cursor:pointer; text-decoration:none; }
  .btn-mini:hover{ text-decoration:underline; }
  .tabs{ display:inline-flex; gap:10px; }
  .tab{ padding:8px 12px; border:1.5px solid var(--red); border-radius:999px; background:var(--white); color:var(--red); font-weight:700; cursor:pointer; transition:background .2s,color .2s; }
  .tab.active{ background:var(--red); color:#fff; }
  .grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(280px,1fr)); gap:18px; align-items:stretch; }
  .card{ background:#fff; border:1.5px solid var(--red); border-radius:16px; box-shadow:0 4px 10px var(--red-soft); overflow:hidden; display:flex; flex-direction:column; transition:transform .25s, box-shadow .25s; }
  .card:hover{ transform:translateY(-3px); box-shadow:0 8px 18px var(--red-soft-2); }
  .thumb{ width:100%; height:180px; object-fit:cover; border-bottom:1px solid #F3DADA; }
  .card-body{ padding:12px; display:flex; flex-direction:column; gap:8px; }
  .h3{ font-family:'Montserrat',sans-serif; font-weight:800; font-size:1.1rem; margin:0; color:var(--red); }
  .meta{ font-size:.9rem; color:#6b6b6b; }
  .excerpt {
    color: #333;
    font-size: .95rem;
    line-height: 1.55;

    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 6;  /* Safari, Chrome lama */
    line-clamp: 6;          /* properti standar modern */

    overflow: hidden;
    max-height: calc(1.55em * 6);
    word-break: break-word;
  }


  /* mobile: tampilkan lebih sedikit baris biar rapi */
  @media (max-width:640px){
  .excerpt{
    -webkit-line-clamp: 4;
    line-clamp: 4;
    max-height: calc(1.55em * 4);
  }
}

  .modal-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); backdrop-filter:blur(5px); display:none; justify-content:center; align-items:center; z-index:100; animation:fadeIn .25s ease-out; }
  .modal-card{ background:#fff; border:2px solid var(--red); border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.25); padding:24px 28px; width:90%; max-width:550px; transform:scale(.97); animation:scaleUp .25s ease-out forwards; }
  .featured-row{ display:inline-flex; align-items:center; gap:8px; margin-top:12px; white-space:nowrap; }
  .featured-row input{ margin:0; } .featured-row span{ font-weight:600; }
  @keyframes fadeIn { from{opacity:0} to{opacity:1} }
  @keyframes scaleUp { to{transform:scale(1)} }
  @keyframes fadeOut { from{opacity:1} to{opacity:0; transform:scale(.95)} }
  label{ display:block; font-weight:600; margin:8px 0 4px; }
  input, textarea, select{ width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; font-family:inherit; }
  @media (max-width:640px){ .controls-row{ flex-wrap:wrap; } }
</style>

<div class="wrap">
  <!-- HEADER -->
  <div class="header-stack">
    <h1 class="title">Garuda Lounge Merchandise</h1>
    <div class="controls-row">
      <div class="tabs">
        <button id="filter-all" class="tab active" type="button">All Merch</button>
        <button id="filter-my"  class="tab" type="button">My Merch</button>
      </div>
      <a href="{% url 'merchandise:create_merch' %}" id="open-create-modal" class="btn">+ Tambah Merchandise</a>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal-overlay" id="create-modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h2 id="modal-title" style="color:#AA1515;font-weight:800;font-size:1.25rem;margin:0;">Tambah Merchandise Baru</h2>
        <button id="close-modal" aria-label="Tutup" style="border:none;background:none;font-size:22px;cursor:pointer;color:#555;">√ó</button>
      </div>

      <form id="create-merch-form" method="POST" action="{% url 'merchandise:add_merch_entry_ajax' %}">
        {% csrf_token %}
        <label>Nama</label>
        <input type="text" name="name" required>

        <label>Deskripsi</label>
        <textarea name="description" rows="4" required></textarea>

        <label>Kategori</label>
        <select name="category" required>
          <option value="">Pilih kategori</option>
          <option value="jersey">Jersey</option>
          <option value="shoes">Shoes</option>
          <option value="gk_gloves">GK Gloves</option>
          <option value="ball">Ball</option>
          <option value="jacket">Jacket</option>
          <option value="scarf">Scarf</option>
        </select>

        <label>Price</label>
        <input type="number" name="price" required>

        <label>Thumbnail URL</label>
        <input type="url" name="thumbnail" placeholder="https://example.com/image.jpg" required>

        <label>Product Link</label>
        <input type="url" name="product_link" placeholder="https://example.com/example-merch" required>

        <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:16px;">
          <button type="button" id="cancel-modal" class="btn-outline">Cancel</button>
          <button type="submit" class="btn">Publish</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Loading & List -->
  <div id="loading" class="empty" style="display:none;">Loading‚Ä¶</div>
  <div id="empty" class="empty" style="display:none;">Belum ada merchandise saat ini.</div>
  <div id="grid" class="grid" style="display:none;"></div>

  <!-- Toast Component -->
  <div 
      id="toast-component"
      class="fixed bottom-8 right-8 p-4 px-8 rounded-xl shadow-xl z-50 
            opacity-0 translate-y-64 transition-all duration-300 
            flex items-center gap-4 bg-[#FFFFFF] border-2 border-[#111111]"
  >
      <span id="toast-icon" class="text-2xl text-[#AA1515]"></span>
      <div>
          <h3 id="toast-title" class="font-['Montserrat'] font-extrabold text-[#111111] text-lg">
              This is a Sample Title
          </h3>
          <p id="toast-message" class="font-['Inter'] text-[#111111]/80 text-sm line-clamp-3">
              This is a Sample Message
          </p>
      </div>
  </div>

  <!-- Load Toast JS -->
  <script src="{% static 'js/toast.js' %}"></script>
</div>

<script>
  /* ===== helpers ===== */
  function labelCategory(code){
    const map = { jersey:'Jersey', shoes:'Shoes', match:'Match', gk_gloves:'GK_Gloves', ball:'Ball', jacket:'Jacket', scarf:'Scarf' };
    return map[code] || code;
  }
  function getCookie(name){
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if(parts.length === 2) return parts.pop().split(";").shift();
  }
  const CSRF = getCookie("csrftoken");
  const safeText = (s) => (s || '').toString();

  /* ===== MODAL ===== */
  const modal = document.getElementById("create-modal");
  const openBtn = document.getElementById("open-create-modal");
  const closeBtn = document.getElementById("close-modal");
  const cancelBtn = document.getElementById("cancel-modal");
  const form = document.getElementById("create-merch-form");

  function openModal(e){
    if (e) e.preventDefault();
    modal.style.display = "flex";
    modal.style.animation = "fadeIn .25s ease-out";
    document.body.style.overflow = "hidden";
    form.querySelector("input[name='title']").focus();
  }
  function closeModal(){
    modal.style.animation = "fadeOut .2s ease-out";
    setTimeout(() => {
      modal.style.display = "none";
      document.body.style.overflow = "";
      form.reset();
    }, 200);
  }
  openBtn.addEventListener("click", openModal);
  [closeBtn, cancelBtn].forEach(btn => btn.addEventListener("click", closeModal));
  modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });

  /* ===== CONSTANTS ===== */
  const MERCH_API_ENDPOINT   = "{% url 'merchandise:show_json' %}";
  const CREATE_API_ENDPOINT = "{% url 'merchandise:add_merch_entry_ajax' %}";
  const CURRENT_USER_ID     = "{{ request.user.id|default_if_none:'' }}";

  const loadingEl = document.getElementById('loading');
  const emptyEl   = document.getElementById('empty');
  const gridEl    = document.getElementById('grid');
  const tabAll    = document.getElementById('filter-all');
  const tabMy     = document.getElementById('filter-my');

  let allMerchData = [];
  // baca ?filter, default ke 'all'
  const urlParams = new URLSearchParams(window.location.search);
  let activeFilter = (urlParams.get('filter') || 'all');

  function setTabs(){
    if (activeFilter === 'my'){
      tabMy.classList.add('active'); tabAll.classList.remove('active');
    }else{
      tabAll.classList.add('active'); tabMy.classList.remove('active');
    }
  }
  function setView({loading=false, empty=false, grid=false}){
    loadingEl.style.display = loading ? 'block' : 'none';
    emptyEl.style.display   = empty   ? 'block' : 'none';
    gridEl.style.display    = grid    ? 'grid'  : 'none';
  }

  function buildMerchCard(n){
    const detailUrl = n.detail_url
      || ((`{% url 'merchandise:show_merch_detail' id='00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', n.id)));

    const canEdit  = !!(CURRENT_USER_ID && String(n.user_id) === String(CURRENT_USER_ID));
    const deleteUrl= `/merchandise/${n.id}/delete/`;

    const card = document.createElement('article');
    card.className = 'card';
    card.innerHTML = `
      ${n.thumbnail ? `<img src="${safeText(n.thumbnail)}" class="thumb" alt="">` : ``}
      <div class="card-body">
        <h3 class="h3"><a href="${detailUrl}" style="color:inherit;text-decoration:none">${safeText(n.name)}</a></h3>
        <div class="meta">${labelCategory(n.category)} ‚Ä¢ Rp.${n.price}</div>
        <p class="excerpt">${safeText(n.description)}</p>
        <div style="margin-top:auto; display:flex; gap:12px; align-items:center;">
          <a href="${detailUrl}" class="btn-mini">Lihat ‚Üí</a>
          ${canEdit ? `
            <a href="/merchanadise/${n.id}/edit/" class="btn-mini">Edit</a>
            <button type="button" class="btn-mini delete-merch" data-id="${n.id}" data-url="${deleteUrl}" style="color:#b3261e;">Delete</button>
          ` : ``}
        </div>
      </div>`;
    return card;
  }

  function renderMerch(list){
    gridEl.innerHTML = '';
    list.forEach(n => gridEl.appendChild(buildMerchCard(n)));
    setView({ grid: list.length > 0, empty: list.length === 0 });
  }

  function applyFilter(){
    const filtered = (activeFilter === 'all')
      ? allMerchData
      : allMerchData.filter(n => String(n.user_id) === String(CURRENT_USER_ID));
    renderMerch(filtered);
  }

  async function fetchMerch(){
    setView({ loading: true });
    try{
      const res = await fetch(MERCH_API_ENDPOINT, { headers: { 'Accept': 'application/json' }});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const arr = Array.isArray(data) ? data : (Array.isArray(data?.results) ? data.results : []);
      console.log('merch/json ->', arr);
      allMerchData = arr;

      // default ke ALL saat reload (biar nggak "hilang")
      if (!['all','my'].includes(activeFilter)) activeFilter = 'all';
      setTabs();
      applyFilter();
    }catch(e){
      console.error('fetchMerch error:', e);
      setView({ empty: true });
    }
  }

  tabAll.addEventListener('click', () => {
    activeFilter = 'all';
    setTabs();
    applyFilter();
  });
  tabMy.addEventListener('click', () => {
    activeFilter = 'my';
    setTabs();
    applyFilter();
  });

  /* ===== CREATE (AJAX) ===== */
  form.addEventListener("submit", async e => {
    e.preventDefault();
    const fd = new FormData(form);

    try{
      const res = await fetch(CREATE_API_ENDPOINT, {
        method: "POST",
        headers: { "X-CSRFToken": CSRF, "Accept":"application/json" },
        body: fd,
        credentials: "same-origin"
      });

      let n = null;
      if (res.headers.get('Content-Type')?.includes('application/json')) {
        n = await res.json();
      }
      if (!res.ok) {
        const msg = n?.error || 'Gagal menambah berita';
        throw new Error(msg);
      }

      const temp = n || {
        id: 'temp-' + Date.now(),
        title: fd.get('title'),
        content: fd.get('content'),
        category: fd.get('category'),
        price: fd.get('price'),
        thumbnail: fd.get('thumbnail'),
        product_link: fd.get('product_link'),
        user_id: "{{ request.user.id|default_if_none:'' }}"
      };
      gridEl.prepend(buildMerchCard(temp));

      closeModal();
      
      // üéâ Tampilkan Toast Success
      if (typeof showToast === 'function') {
        showToast('Merchandise Berhasil Ditambahkan!', 'Merchandise kamu sudah dipublish.', 'success');
      }
      
      // reset ke ALL supaya terlihat
      activeFilter = 'all'; setTabs();
      fetchMerch();
    }catch(err){
      // ‚ùå Tampilkan Toast Error
      if (typeof showToast === 'function') {
        showToast('Gagal Menambah Merchandise!', err.message || 'Terjadi kesalahan saat mempublish merchandise.', 'error');
      } else {
        alert("no" + (err.message || "Gagal membuat merchandise."));
      }
      console.error(err);
    }
  });

  /* ===== DELETE (POST + CSRF) ===== */
  gridEl.addEventListener('click', async (e) => {
    const btn = e.target.closest('.delete-merch');
    if (!btn) return;

    const url  = btn.dataset.url;
    const card = btn.closest('article');

    // Optimistic UI
    btn.disabled = true;
    card.style.transition = 'opacity .18s ease, transform .18s ease';
    card.style.opacity = '0.55';
    card.style.transform = 'scale(0.995)';

    try{
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'X-CSRFToken': CSRF, 'Accept': 'application/json' },
        credentials: 'same-origin'
      })

      if (!res.ok) {
        const txt = await res.text().catch(()=> '');
        console.error('Delete failed', res.status, txt);
        card.style.opacity = '1';
        card.style.transform = 'none';
        btn.disabled = false;
        
        // ‚ùå Toast Error
        if (typeof showToast === 'function') {
          showToast('Gagal Menghapus!', 'Merchandise tidak bisa dihapus.', 'error');
        } else {
          alert('Gagal menghapus.');
        }
        return;
      }

      // Toast Success
      if (typeof showToast === 'function') {
        showToast('Merchandise Berhasil Dihapus!', 'Merchandise sudah dihapus dari list.', 'success');
      }

      card.style.opacity = '0';
      card.style.transform = 'scale(0.98)';
      setTimeout(() => card.remove(), 180);

    }catch(err){
      card.style.opacity = '1';
      card.style.transform = 'none';
      btn.disabled = false;
      
      // ‚ùå Toast Error
      if (typeof showToast === 'function') {
        showToast('Gagal Menghapus!', 'Terjadi kesalahan.', 'error');
      } else {
        alert('Gagal menghapus.');
      }
      console.error(err);
    }
  });

  // init
  setTabs();
  fetchMerch();
</script>
{% endblock %}