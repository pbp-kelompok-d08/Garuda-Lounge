{% extends 'base_merch.html' %}
{% load static %}

{% block title %}Garuda Lounge Merchandise{% endblock %}

{% block content %}
<style>
  :root{
    --bg:#E7E3DD; --red:#AA1515; --black:#111; --white:#fff;
    --red-soft: rgba(170,21,21,.22);
    --red-soft-2: rgba(170,21,21,.32);
  }

  .wrap{ max-width:1000px; margin:0 auto; padding:40px 16px; text-align:center; }
  .title{ font-family:'Montserrat',sans-serif; font-weight:800; color:var(--red); margin:0 0 10px; }

  /* Tombol kecil  "View Details" */
  .btn-mini {
    font-size: 0.75rem !important;
    font-weight: 600;
    color: var(--red) !important;
    background: transparent !important;
    border: none !important;
    text-decoration: none !important;
    display: inline-block;
    line-height: 1.2;
    transition: color .2s ease, transform .2s ease, text-decoration .2s ease;
  }
  .btn-mini:hover {
    color: #7f0f12 !important;
    text-decoration: underline !important;
    transform: translateY(-1px);
  }

  /* Buttons (untuk Tambah Merchandise) */
  .btn{
    display:inline-block;
    padding:8px 14px;
    border-radius:8px;
    border:1.5px solid var(--red);
    background:var(--red);
    color:var(--white);
    font-weight:700;
    cursor:pointer;
    transition:filter .2s, transform .2s;
    text-decoration:none !important;  
  }
  .btn:hover{
    filter:brightness(1.05);
    transform:translateY(-1px);
    text-decoration:none !important;   
  }

  .btn-outline{
    background:transparent; color:var(--red); border:1.5px solid var(--red);
  }

  /* Tabs */
  .tabs{ display:inline-flex; gap:10px; margin:18px 0 28px; }
  .tab{
    padding:8px 12px; border:1.5px solid var(--red); border-radius:999px;
    background:var(--white); color:var(--red); font-weight:700; cursor:pointer;
    transition:background .2s,color .2s;
  }
  .tab.active{ background:var(--red); color:#fff; }

  /* Grid & Card */
  .grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(280px,1fr)); gap:18px; align-items:stretch; }
  .card{
    background:#fff;
    border:1.5px solid var(--red);
    border-radius:16px;
    box-shadow:0 4px 10px var(--red-soft);
    text-align:left; overflow:hidden; display:flex; flex-direction:column;
    transition:transform .25s, box-shadow .25s;
  }
  .card:hover{
    transform:translateY(-3px);
    box-shadow:0 8px 18px var(--red-soft-2);
  }

  .thumb{ width:100%; height:180px; object-fit:cover; border-bottom:1px solid #F3DADA; }
  .card-body{ padding:12px; display:flex; flex-direction:column; gap:8px; }
  .h3{ font-family:'Montserrat',sans-serif; font-weight:800; font-size:1.1rem; margin:0; color:var(--red); }
  .meta{ font-size:.9rem; color:#6b6b6b; }
  .excerpt{
    color:#333; font-size:.95rem; line-height:1.5;
    display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden;
  }
  .empty{ color:#111; margin-top:26px; }
</style>

<div class="wrap">
  <h1 class="title">Garuda Lounge Merchandise</h1>

  <div class="tabs">
    <button id="filter-all" class="tab active">All Merchandise</button>
    <button id="filter-my"  class="tab">My Merchandise</button>
  </div>

  <!-- Tombol tambah berita -->
  <div>
    <a href="{% url 'merchandise:create_merch' %}" class="btn">+ Tambah Merchandise</a>
  </div>

  <div id="loading" class="empty" style="display:none;">Loadingâ€¦</div>

  <div id="grid" class="hidden">
    {% for merch in merch_list %}
          {% include 'card_merch.html' with merch=merch %}
        {% endfor %}
  </div>
  

  <div id="empty" class="empty" style="display:none;">
    <img src="{% static 'image/no-merch.png' %}" alt="No merchandise"
         style="width:110px;height:110px;opacity:.7;display:block;margin:0 auto 8px;">
    Belum ada merchandise saat ini.
  </div>

</div>

<script>
  const MERCH_API_ENDPOINT = "{% url 'merchandise:show_json' %}";
  const CURRENT_USER_ID = "{{ request.user.id|default_if_none:'' }}";

  const loadingEl = document.getElementById('loading');
  const emptyEl   = document.getElementById('empty');
  const gridEl    = document.getElementById('grid');
  const tabAll    = document.getElementById('filter-all');
  const tabMy     = document.getElementById('filter-my');
  const errorEl   = document.getElementById('error');

  let allMerchData = [];
  let activeFilter = 'all';


  function displayPageSection({ showLoading = false, showError = false, showEmpty = false, showGrid = false }) {
  loadingEl.classList.toggle('hidden', !showLoading);
  errorEl.classList.toggle('hidden', !showError);
  emptyEl.classList.toggle('hidden', !showEmpty);
  gridEl.classList.toggle('hidden', !showGrid);
  
  // Add grid classes when showing grid
  if (showGrid) {
    gridEl.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
  }
}


  function getReadableCategoryName(categoryCode) {
  const categoryMapping = {
    jersey: 'Jersey',
    shoes: 'Shoes',
    gk_gloves: 'GK Gloves',
    ball: 'Ball',
    jacket: 'Jacket',
    scarf: 'Scarf',
  };
  return categoryMapping[categoryCode] || categoryCode;
}

  function buildMerchCard(n) {
    const article = document.createElement('article');
    article.className = 'bg-white rounded-lg border border-gray-200 hover:shadow-lg transition-shadow duration-300 overflow-hidden flex flex-col h-full';
    const linkDetail = `/merchandise/${n.id}/`;
    const linkEdit   = `/merchandise/${n.id}/edit/`;
    const linkDelete = `/merchandise/${n.id}/delete/`;
    const canEdit    = !!(CURRENT_USER_ID && String(n.user_id) === String(CURRENT_USER_ID));

    const name = DOMPurify.sanitize(n.name);
    const description = DOMPurify.sanitize(n.description);
    const category = DOMPurify.sanitize(n.category);
    const thumbnail = DOMPurify.sanitize(n.thumbnail);
    const price = DOMPurify.sanitize(n.price);

    const thumbnailHtml = DOMPurify.sanitize(
        item.thumbnail ? `<img src='${thumbnail}' alt='${name}' class='w-full h-full object-cover'>` : `<div class='w-full h-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center'></div>`
    );
    const categoryLabel = DOMPurify.sanitize(getReadableCategoryName(category));

    const editDeleteHtml = CURRENT_USER_ID && Number(CURRENT_USER_ID) === Number(item.user_id)
        ? `<div class='flex space-x-2'>
            <a href='${linkEdit}' class='text-gray-600 hover:text-gray-700 text-sm transition-colors'>Edit</a>
            <a href='${linkDelete}' class='text-red-600 hover:text-red-700 text-sm transition-colors' onclick='return confirm("Are you sure you want to delete this article?")'>Delete</a>
          </div>`
        : '';

    const cardHtml = `
        <div class="aspect-[16/9] relative overflow-hidden">
          ${thumbnailHtml}
          <div class="absolute top-3 left-3">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-green-600 text-white">${categoryLabel}</span>
          </div>
        </div>
        <div class="p-5 flex flex-col flex-1">
          <h3 class="text-lg font-semibold text-gray-900 mb-3 line-clamp-2 leading-tight">
            <a href="${linkDetail}" class="hover:text-green-600 transition-colors">${name}</a>
          </h3>
          <p class="text-gray-600 text-sm leading-relaxed line-clamp-3 mb-4">Rp.${price}</p>
          <p class="text-gray-600 text-sm leading-relaxed line-clamp-3 mb-4">${description}</p>
          <div class="pt-4 border-t border-gray-100 flex items-center justify-between">
            <a href="${linkDetail}" class="text-green-600 hover:text-green-700 font-medium text-sm transition-colors">See Details</a>
            ${editDeleteHtml}
          </div>
        </div>
    `;
    
    article.innerHTML = cardHtml;
    return article;
  }

  function renderMerch(list) {
    gridEl.innerHTML = '';
    list.forEach(list => {
        const cardElement = buildNewsCardElement(list);
        gridEl.appendChild(cardElement);
    });
  }

  function applyFilter() {
    const filtered = (activeFilter === 'all')
      ? allMerchData
      : allMerchData.filter(n => String(n.user_id) === String(CURRENT_USER_ID));

    if (filtered.length === 0) {
    displayPageSection({ showEmpty: true });
  } else {
    renderMerch(filtered);
    displayPageSection({ showGrid: true });
  }
  }

  async function fetchMerch() {
    setView({ loading: true });
    try {
    displayPageSection({ showLoading: true });
    
    const response = await fetch(MERCH_API_ENDPOINT, {
      headers: { 'Accept': 'application/json' },
    });

    if (!response.ok) {
      throw new Error('Failed to fetch news data from server');
    }

    const merchData = await response.json();
    allMerchData = merchData || [];
    
    filterAndDisplayNews();
  } catch (error) {
    console.error('Error loading news:', error);
    displayPageSection({ showError: true });
  }
  }

  tabAll.addEventListener('click', () => {
    activeFilter = 'all';
    tabAll.classList.add('active'); tabMy.classList.remove('active');
    applyFilter();
  });
  tabMy.addEventListener('click', () => {
    activeFilter = 'my';
    tabMy.classList.add('active'); tabAll.classList.remove('active');
    applyFilter();
  });

  fetchMerch();
  document.addEventListener('merchAdded', () => fetchMerch());
</script>
{% endblock %}

{% include 'toast.html' %}
{% include 'modal.html' %}