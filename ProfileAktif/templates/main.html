{% extends 'base_profileAktif.html' %}
{% load static %}

{% block content %}
<style>
  :root{
    --bg:#E7E3DD; --red:#AA1515; --black:#111; --white:#fff;
    --red-soft: rgba(170,21,21,.22);
    --red-soft-2: rgba(170,21,21,.32);
  }

  body {
    font-family: 'Poppins', sans-serif;
    background-color: var(--bg);
    color: var(--black);
  }

  .wrap{
    max-width:1000px;
    margin:0 auto;
    padding:40px 16px;
    text-align:center;
  }

/* Container untuk back button */
.back-button-container {
    position: relative;
    text-align: left;
    margin-bottom: 20px;
}

/* Back button */
.back-btn {
    position: absolute;
    left: 0;
    top: 0;
    background: var(--red);
    color: var(--white);
    font-weight: 700;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.9rem;
    padding: 10px 18px;
    border: none;
    border-radius: 10px;
    text-decoration: none;
    cursor: pointer;
    box-shadow: 0 4px 10px var(--red-soft);
    transition: background .2s, transform .2s, box-shadow .2s;
}

.back-btn:hover {
    background: #8b1010;
    transform: translateY(-2px);
    box-shadow: 0 6px 14px var(--red-soft-2);
}
  /* Heading title */
  .title{
    font-family:'Montserrat',sans-serif;
    font-weight:800;
    color:var(--red);
    font-size:1.8rem;
    margin:68px 0 24px;
  }

  /* Button "Tambah Pemain" */
  .btn{
    display:inline-block;
    padding:8px 14px 40px;
    border-radius:8px;
    border:1.5px solid var(--red);
    background:var(--red);
    color:var(--white);
    font-weight:700;
    cursor:pointer;
    transition:filter .2s, transform .2s;
    text-decoration:none !important;
  }
  .btn:hover{
    background: #8b1010;
    filter:brightness(1.05);
    transform:translateY(-1px);
    text-decoration:none !important;
  }

  /* Grid layout untuk 4 card sebaris */
  .player-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);   /* 4 card sebaris */
    gap: 1rem;                               /* Jarak antar card */
    padding: 1rem 0;
  }

  /* Responsive design: when screen width is less than 768px, change to 2 cards per row */
@media (max-width: 768px) {
  .player-grid {
    grid-template-columns: repeat(2, 1fr);   /* 2 cards per row for smaller screens */
  }
}
  
/* Kecilkan ukuran card */
  .player-card {
    background: #fff;
    border: 1.5px solid var(--red);
    border-radius: 16px;
    box-shadow: 0 4px 10px var(--red-soft);
    overflow: hidden;
    transition: transform .25s, box-shadow .25s;
    height: 100%;                            /* Supaya card lebih kompak */
    display: flex;
    flex-direction: column;
  }
  .player-card:hover{
    transform:translateY(-3px);
    box-shadow:0 8px 18px var(--red-soft-2);
  }
  .player-card img {
    width: 100%;
    height: 160px; /* Adjust this value based on your desired card height */
    object-fit: cover;   /* Ensures the image covers the entire space */
    object-position: top; /* Aligns the top of the image with the top of the card */
  }
  .player-content {
    padding: 1rem;
    text-align: left;
    display: flex;
    flex-direction: column;
    gap: .35rem;
    padding-right: 1rem;
  }
  .player-name {
    font-family:'Montserrat',sans-serif;
    font-weight:800;
    color:var(--red);
    /* ubah margin biar lebih rapat: */
    margin: .2rem 0 .1rem;
    line-height:1.2;
  }
  .player-info {
    font-size:0.9rem; 
    color:#333;
    /* rapetin tiap baris info: */
    margin: .15rem 0;
  }
  .button-container {
    display: flex;
    justify-content: center;
    padding: 0 1rem;            /* Padding kiri-kanan di container tombol */
    width: 100%;
    box-sizing: border-box;     /* Make sure padding terhitung dalam lebar */
  }

  .btn-detail {
    background-color: var(--red);
    color: #fff;
    padding: 0.5rem;
    font-size: 0.9rem;
    border-radius: 8px;
    text-decoration: none;
    transition: filter 0.2s;
    display: block;
    width: 100%;
    text-align: center;
    margin-top: 0.75rem;
    box-sizing: border-box;
    font-family: 'Poppins', sans-serif;
  }

  .btn-detail:hover { filter:brightness(1.05); }

  .centered { text-align:center; padding:3rem; }
  .hidden { display:none; }

    .btn-edit,
  .btn-delete {
    display: block;
    width: 100%;
    text-align: center;
    padding: 0.45rem;
    font-size: 0.85rem;
    border-radius: 8px;
    text-decoration: none;
    margin-top: 0.4rem;
    box-sizing: border-box;
    font-family: 'Poppins', sans-serif;
    font-weight: 500;
  }

  .btn-edit {
    background-color: #ffffff;
    color: var(--red);
    border: 1px solid var(--red);
  }

  .btn-edit:hover {
    background-color: var(--red-soft);
  }

  .btn-delete {
    background-color: #ffffff;
    color: #b00020;
    border: 1px solid #b00020;
  }

  .btn-delete:hover {
    background-color: rgba(176,0,32,0.1);
  }

/* Styling wrapper filter */
.filter-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    margin: 24px 0 16px;
    font-family: 'Poppins', sans-serif;
}

/* Label "Filter posisi" */
.filter-label {
    font-weight: 600;
    color: var(--black);
    font-size: 0.95rem;
}

/* Dropdown styling */
#filter-posisi {
    padding: 10px 14px;
    border-radius: 10px;
    border: 1.5px solid #b00020;
    background-color: #fff;
    font-size: 0.80rem;
    font-family: 'Poppins', sans-serif;
    color: #b00020;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    outline: none;
    appearance: none;

    /* arrow icon */
    background-image: url("data:image/svg+xml;utf8,<svg fill='%23b00020' height='14' viewBox='0 0 24 24' width='14' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
    background-repeat: no-repeat;
    background-position: right 12px center;
}


/* Saat hover */
#filter-posisi:hover {
    border-color: #b00020;
    box-shadow: 0 3px 8px rgba(176,0,32,0.15);
}


/* Saat dropdown sedang dibuka (focus state) */
#filter-posisi:focus {
    background-color: #f1e5e5;        /* sama kayak tombol Edit */
    color: #b00020;
    border-color: #b00020;
    box-shadow: 0 0 0 2px rgba(176, 0, 32, 0.25);
}


/* Style warna option di dalam dropdown */
#filter-posisi option {
    font-family: 'Poppins', sans-serif;
    padding: 8px;
    color: #b00020;
    background-color: #ffffff;
}

/* Saat option di-hover (beberapa browser support) */
#filter-posisi option:hover {
    background-color: #f8dada;
    color: #b00020;
}



/* Modal Styles - Red Theme */
.modal {
    display: none;                 /* akan diubah ke "flex" dari JS saat dibuka */
    position: fixed;
    z-index: 1001;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    
    /* bikin konten di tengah */
    display: none;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: white;
    padding: 0;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    font-family: 'Inter', sans-serif;
    border: 2px solid var(--red);
    overflow: hidden;
    max-height: 90vh;
    overflow-y: auto;
}

/* Header Styles */
.modal-header {
    padding: 24px 24px 16px;
    background-color: white;
    border-bottom: 2px solid var(--red); /* Garis merah di header */
}

.modal-header h2 {
    font-family: 'Montserrat', sans-serif; /* Font Montserrat untuk judul */
    font-weight: 800;
    color: var(--red);
    font-size: 1.5rem;
    margin: 0 0 8px 0;
}

.modal-header p {
    color: var(--black);
    margin: 0;
    font-size: 0.95rem;
    font-weight: 500;
}

.close {
    color: #666;
    float: right;
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
    margin-top: -8px;
    transition: color 0.2s;
}

.close:hover {
    color: var(--red);
}

/* Form Container */
.form-container {
    padding: 24px;
}

/* Form Group Styles */
.form-group {
    margin-bottom: 1.5rem;
    text-align: left;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--black);
    font-family: 'Inter', sans-serif;
    font-size: 0.95rem;
}

.form-group input, 
.form-group select {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    font-family: 'Inter', sans-serif;
    background-color: white;
    transition: all 0.2s;
    box-sizing: border-box;
}

.form-group input:focus, 
.form-group select:focus {
    outline: none;
    border-color: var(--red);
    box-shadow: 0 0 0 3px var(--red-soft);
}

.form-group input::placeholder {
    color: #999;
}

/* Button Group Styles */
.button-group {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid #e5e7eb;
}

@media (min-width: 480px) {
    .button-group {
        flex-direction: row;
        justify-content: flex-end;
    }
}

.cancel-btn {
    background-color: white;
    color: var(--red);
    border: 2px solid var(--red);
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-family: 'Inter', sans-serif;
    transition: all 0.2s;
    text-decoration: none;
    text-align: center;
    font-size: 0.95rem;
    order: 2;
}

.cancel-btn:hover {
    background-color: var(--red-soft);
}

.submit-btn {
    background-color: var(--red);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-family: 'Inter', sans-serif;
    transition: background-color 0.2s;
    font-size: 0.95rem;
    order: 1;
    flex: 1;
}

.submit-btn:hover {
    background-color: #8b1010;
}

@media (min-width: 480px) {
    .cancel-btn {
        order: 1;
        flex: none;
        min-width: 100px;
    }
    .submit-btn {
        order: 2;
        flex: none;
        min-width: 140px;
    }
}

/* Small text for optional fields */
.form-group small {
    display: block;
    margin-top: 6px;
    color: #666;
    font-size: 0.8rem;
    font-weight: normal;
    line-height: 1.4;
}

</style>

<div class="wrap">
  <!-- Container khusus untuk back button -->
  <div class="back-button-container">
    <a href="{% url 'main:show_main' %}" class="back-btn">← Back to Main Page</a>
  </div>

  <h1 class="title">Pemain Aktif Timnas Indonesia</h1>
  <!-- FILTER POSISI -->
  <div class="filter-wrapper">
    <span class="filter-label">Filter posisi</span>

    <select id="filter-posisi">
        <option value="">Semua posisi</option>
        <option value="GK">Goalkeeper</option>
        <option value="DF">Defender</option>
        <option value="MF">Midfielder</option>
        <option value="FW">Forward</option>
    </select>
  </div>


  <button 
    onclick="showPlayerModal()" 
    class="tambah-btn"
    style="background-color: #a4161a; color: white; border: none; padding: 10px 16px; border-radius: 8px; font-weight: 600; cursor: pointer;">
      + Tambah Pemain
  </button>

  <div id="loading" class="centered hidden">
    <p>⏳ Sedang memuat data pemain...</p>
  </div>

  <div id="error" class="centered text-red hidden">
    <p>⚠️ Gagal memuat data pemain. Coba refresh halaman.</p>
  </div>

  <div id="empty" class="centered hidden">
    <p>Belum ada data pemain yang tersimpan.</p>
  </div>

  <div id="grid" class="player-grid hidden"></div>
</div>

<!-- Modal untuk Tambah Pemain -->
<div id="playerModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <span class="close" onclick="closePlayerModal()">&times;</span>
      <h2>Tambah Pemain Baru</h2>
      <p>Lengkapi data pemain aktif timnas Indonesia</p>
    </div>
    
    <div class="form-container">
      <!-- HAPUS ID="playerForm" dan biarkan form submit normal -->
      <form id="playerForm" method="POST" action="{% url 'ProfileAktif:create_player' %}">
        {% csrf_token %}
        
        <div class="form-group">
          <label for="nama">Nama</label>
          <input type="text" id="nama" name="nama" placeholder="Masukkan nama pemain" required>
        </div>
        
        <div class="form-group">
          <label for="posisi">Posisi</label>
          <select id="posisi" name="posisi" required>
            <option value="">Pilih posisi</option>
            <option value="GK">Goalkeeper</option>
            <option value="DF">Defender</option>
            <option value="MF">Midfielder</option>
            <option value="FW">Forward</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="klub">Klub</label>
          <input type="text" id="klub" name="klub" placeholder="Nama klub pemain" required>
        </div>
        
        <div class="form-group">
          <label for="umur">Umur</label>
          <input type="number" id="umur" name="umur" placeholder="Masukkan umur" required>
        </div>
        
        <div class="form-group">
          <label for="market_value">Market Value (Rp)</label>
          <input type="number" id="market_value" name="market_value" placeholder="Contoh: 150000" step="0.01" required>
        </div>
        
        <div class="form-group">
          <label for="foto">URL Foto</label>
          <input type="url" id="foto" name="foto" placeholder="https://contoh.com/foto.jpg">
          <small>Opsional. Gunakan URL gambar lengkap.</small>
        </div>
        
        <div class="button-group">
          <button type="button" class="cancel-btn" onclick="closePlayerModal()">Cancel</button>
          <!-- UBAH TYPE MENJADI "submit" -->
          <button type="submit" class="submit-btn">Tambah Pemain</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Delete Pemain -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <span class="close" onclick="closeDeleteModal()">&times;</span>
      <h2>Hapus Pemain</h2>
      <p>Yakin ingin menghapus pemain ini dari daftar?</p>
    </div>

    <div class="form-container">
      <div style="margin-bottom: 16px; color:#444; font-size:0.95rem;">
        Data pemain yang sudah dihapus tidak dapat dikembalikan.
      </div>
      <div class="button-group">
        <button type="button" class="cancel-btn" onclick="closeDeleteModal()">Batal</button>
        <button type="button" class="submit-btn" onclick="confirmDelete()">Hapus</button>
      </div>
    </div>
  </div>
</div>



<script>
  const PLAYER_API_ENDPOINT = "{% url 'ProfileAktif:show_json' %}";
  const loading = document.getElementById("loading");
  const error = document.getElementById("error");
  const empty = document.getElementById("empty");
  const grid = document.getElementById("grid");
  const modal = document.getElementById("playerModal");
  const deleteModal = document.getElementById("deleteModal");
  let playerToDeleteId = null;
  let isEditMode = false;
  let editingPlayerId = null;
  let playersCache = {};
  let allPlayers = []; 


  // Modal functions
  function showPlayerModal() {
    isEditMode = false;
    editingPlayerId = null;

    const headerTitle = document.querySelector('#playerModal .modal-header h2');
    const headerDesc = document.querySelector('#playerModal .modal-header p');
    const form = document.getElementById('playerForm');

    headerTitle.textContent = 'Tambah Pemain Baru';
    headerDesc.textContent = 'Lengkapi data pemain aktif timnas Indonesia';
    form.reset();

    modal.style.display = "flex";
    document.body.style.overflow = "hidden";
  }


  function closePlayerModal() {
      modal.style.display = "none";
      document.body.style.overflow = "auto"; // Restore body scroll
  }

  function openDeleteModal(playerId) {
    playerToDeleteId = playerId;
    deleteModal.style.display = "flex";
    document.body.style.overflow = "hidden";
  }

  function closeDeleteModal() {
    deleteModal.style.display = "none";
    document.body.style.overflow = "auto";
    playerToDeleteId = null;
  }

  function openEditModal(playerId) {
    const player = playersCache[playerId];
    if (!player) return;

    isEditMode = true;
    editingPlayerId = playerId;

    const headerTitle = document.querySelector('#playerModal .modal-header h2');
    const headerDesc = document.querySelector('#playerModal .modal-header p');
    const form = document.getElementById('playerForm');

    headerTitle.textContent = 'Edit Pemain';
    headerDesc.textContent = 'Ubah data pemain aktif timnas Indonesia';

    document.getElementById('nama').value = player.nama || '';
    document.getElementById('posisi').value = player.posisi_kode || '';
    document.getElementById('klub').value = player.klub || '';
    document.getElementById('umur').value = player.umur || '';
    document.getElementById('market_value').value = player.market_value || '';
    document.getElementById('foto').value = player.foto || '';

    modal.style.display = "flex";
    document.body.style.overflow = "hidden";
  }


  // Close modal when clicking outside
  window.onclick = function(event) {
    if (event.target == modal) {
      closePlayerModal();
    }
    if (event.target == deleteModal) {
      closeDeleteModal();
    }
  }


  // Close modal with Escape key
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      if (modal.style.display === 'block' || modal.style.display === 'flex') {
        closePlayerModal();
      }
      if (deleteModal.style.display === 'block' || deleteModal.style.display === 'flex') {
        closeDeleteModal();
      }
    }
  });

  function showSection({ showLoading = false, showError = false, showEmpty = false, showGrid = false }) {
    loading.classList.toggle("hidden", !showLoading);
    error.classList.toggle("hidden", !showError);
    empty.classList.toggle("hidden", !showEmpty);
    grid.classList.toggle("hidden", !showGrid);
  }

  function createPlayerCard(player) {
    const card = document.createElement("div");
    card.className = "player-card";
    const imgSrc = player.foto ? player.foto : "https://via.placeholder.com/200x200?text=No+Photo";
    card.innerHTML = `
      <img src="${imgSrc}" alt="${player.nama}">
      <div class="player-content">
        <h3 class="player-name">${player.nama}</h3>
        <p class="player-info"><strong>Posisi:</strong> ${player.posisi}</p>
        <p class="player-info"><strong>Klub:</strong> ${player.klub}</p>
        <p class="player-info"><strong>Umur:</strong> ${player.umur}</p>
        <p class="player-info"><strong>Market Value:</strong> Rp${player.market_value} Miliar</p>
        <div class="button-container" style="flex-direction:column;align-items:stretch;">
          <a href="/ProfileAktif/player/${player.id}/" class="btn-detail">Detail Pemain</a>
          <button type="button" class="btn-edit" onclick="openEditModal('${player.id}')">Edit</button>
          <button type="button" class="btn-delete" onclick="openDeleteModal('${player.id}')">Delete</button>
        </div>
      </div>
    `;
    return card;
  }


  function renderPlayers(players) {
    grid.innerHTML = "";
    playersCache = {};              // reset cache

    players.forEach(player => {
      playersCache[player.id] = player;
      grid.appendChild(createPlayerCard(player));
    });
  }

  function applyFilter() {
    const select = document.getElementById('filter-posisi');
    const value = select.value;   // "", "GK", "DF", "MF", "FW"

    let filtered = allPlayers;

    if (value) {
      filtered = allPlayers.filter(p => {
        // pakai posisi_kode kalau ada, kalau tidak pakai posisi
        return (p.posisi_kode || p.posisi) === value;
      });
    }

    if (filtered.length === 0) {
      grid.innerHTML = "";
      showSection({ showEmpty: true });
    } else {
      renderPlayers(filtered);
      showSection({ showGrid: true });
    }
  }


  async function fetchPlayers() {
    try {
      showSection({ showLoading: true });
      const response = await fetch(PLAYER_API_ENDPOINT);
      if (!response.ok) throw new Error("Gagal fetch data");
      const data = await response.json();

      allPlayers = data;   // simpan semua pemain di memori

      if (allPlayers.length === 0) {
        showSection({ showEmpty: true });
      } else {
        applyFilter();     // langsung apply filter sesuai pilihan sekarang
      }
    } catch (err) {
      console.error(err);
      showSection({ showError: true });
    }
  }



  async function confirmDelete() {
    if (!playerToDeleteId) return;

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    try {
      const response = await fetch(`/ProfileAktif/player/${playerToDeleteId}/delete/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        }
      });

      if (!response.ok) throw new Error('Gagal menghapus pemain');

      const data = await response.json();
      if (data.success) {
        closeDeleteModal();
        await fetchPlayers();  // refresh grid biar card langsung hilang
        if (typeof showToast === 'function') {
          showToast('Berhasil', 'Pemain berhasil dihapus', 'success');
        }
      }
    } catch (err) {
      console.error(err);
      if (typeof showToast === 'function') {
        showToast('Error', 'Terjadi kesalahan saat menghapus pemain', 'error');
      }
    }
  }


  // === AJAX submit untuk form Tambah Pemain ===
  // Pakai event delegation supaya tetap nempel meski modal dimuat ulang.
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('playerForm');
    if (!form) return;

    form.addEventListener('submit', async function(e) {
      e.preventDefault();

      const submitBtn = form.querySelector('.submit-btn');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Memproses...';
      submitBtn.disabled = true;

      const wasEdit = isEditMode;   // simpan mode sebelum di-reset

      try {
        const formData = new FormData(form);
        const url = wasEdit
          ? `/ProfileAktif/player/${editingPlayerId}/edit/`
          : form.action;

        const response = await fetch(url, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        });

        const data = await response.json();
        console.log('Response:', data);

        if (data.success) {
          closePlayerModal();
          form.reset();
          isEditMode = false;
          editingPlayerId = null;

          await fetchPlayers(); // refresh grid

          if (typeof showToast === 'function') {
            showToast(
              'Berhasil!',
              wasEdit ? 'Data pemain berhasil diperbarui' : 'Pemain berhasil ditambahkan',
              'success'
            );
          }
        } else {
          let msg = 'Data tidak valid.';
          if (data.errors) {
            msg = Object.values(data.errors).flat().join(' ');
          }
          if (typeof showToast === 'function')
            showToast('Gagal!', msg, 'error');
        }
      } catch (err) {
        console.error(err);
        if (typeof showToast === 'function')
          showToast('Error!', 'Terjadi kesalahan jaringan', 'error');
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });

    const filterSelect = document.getElementById('filter-posisi');
    if (filterSelect) {
      filterSelect.addEventListener('change', function() {
        applyFilter();
      });
    }
  });


  // Initial fetch
  fetchPlayers();

  // Listen for player added event
  document.addEventListener('playerAdded', function() {
    fetchPlayers();
  });
</script>
{% endblock content %}